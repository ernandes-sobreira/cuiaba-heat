<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cuiabá — Limiar térmico + IDT/THI | INMET 2003–2024</title>
  <meta name="theme-color" content="#ffffff"/>
  <style>
    :root{--bg:#fff;--card:#fff;--stroke:#e8e8ef;--txt:#0f172a;--muted:#64748b;--marsala:#7a2f3a;--orange:#f28c28;--soft:#fff6ef;--shadow:0 10px 28px rgba(2,6,23,.08);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#fff 0%,#fff9f5 60%,#fff 100%);color:var(--txt)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 60px}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin:10px 0 14px}
    .title{display:flex;flex-direction:column;gap:6px}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:8px 10px;font-size:12px;color:var(--muted)}
    .pill b{color:var(--txt)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tabbtn{border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:10px 12px;font-size:12px;cursor:pointer}
    .tabbtn.active{border-color:rgba(122,47,58,.35);background:linear-gradient(180deg,#fff 0%,#fff5f6 100%)}
    .tab{display:none}
    .tab.active{display:block}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card+.card{margin-top:14px}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px 16px}
    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi{grid-column:span 12;border:1px dashed #edd7dc;background:linear-gradient(180deg,#fff 0%,var(--soft) 100%);border-radius:16px;padding:12px;min-height:64px}
    @media(min-width:820px){.kpi{grid-column:span 4}}
    .kpi .lab{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .val{font-size:18px;font-weight:750}
    .kpi .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.3}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:10px 12px;font-size:12px;cursor:pointer}
    .btn.primary{border-color:rgba(122,47,58,.35);background:linear-gradient(180deg,#fff 0%,#fff5f6 100%)}
    .select{border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:12px;background:#fff}
    .input{border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:12px;background:#fff;width:120px}
    .note{font-size:12px;color:var(--muted);line-height:1.45}
    .split{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col6{grid-column:span 12}
    @media(min-width:980px){.col6{grid-column:span 6}}
    canvas{width:100%;height:340px}
    .small canvas{height:280px}
    .divider{height:1px;background:var(--stroke);margin:12px 0}
    .tablewrap{overflow:auto;border:1px solid var(--stroke);border-radius:14px}
    table{border-collapse:collapse;width:100%;min-width:820px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--stroke);font-size:12px;text-align:right;white-space:nowrap}
    th{position:sticky;top:0;background:#fff;color:var(--muted)}
    td:first-child,th:first-child{text-align:left}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:11px;color:var(--muted);background:#fff}
    .errbox{display:none;margin:12px 0;padding:12px;border-radius:14px;border:1px solid #f1c7cf;background:#fff1f3;color:#7a2f3a;font-size:12px;white-space:pre-wrap}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Cuiabá — limiar térmico + IDT/THI <span class="tag">GitHub Pages</span></h1>
      <div class="sub">Versão leve: carrega os dados por <b>data.json</b> (melhor no celular).</div>
    </div>
    <div class="pillbar">
      <div class="pill"><b>Período:</b> <span id="cov">—</span></div>
      <div class="pill"><b>Limiar:</b> <span id="thrShow">—</span>°C</div>
      <div class="pill"><b>Status:</b> <span id="status">carregando…</span></div>
    </div>
  </header>

  <div id="err" class="errbox"></div>

  <div class="tabs">
    <button class="tabbtn active" data-tab="tabVisao">Visão geral</button>
    <button class="tabbtn" data-tab="tabTabelas">Tabelas</button>
  </div>

  <section id="tabVisao" class="tab active">
    <div class="card">
      <div class="hd">
        <h2>Limiar de temperatura (personalizável)</h2>
        <div class="controls">
          <span class="note">Limiar (°C)</span>
          <input class="input" id="thrInput" type="number" step="0.1" min="-10" max="60"/>
          <button class="btn primary" id="applyThr">Aplicar</button>
          <button class="btn" id="resetThr">Voltar para 31,5</button>
          <span class="note">• Dia = Tx • Noite = Tn</span>
        </div>
      </div>
      <div class="bd">
        <div class="controls" style="margin-bottom:10px">
          <button class="btn primary" id="viewYear">Ver por ano</button>
          <button class="btn" id="viewMonth">Ver por mês</button>
          <select class="select" id="yearPick"></select>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="lab">Dia mais quente (Tx)</div><div class="val" id="k_hottest_day">—</div><div class="mini" id="k_hottest_day_mini">—</div></div>
          <div class="kpi"><div class="lab">Noite mais quente (Tn)</div><div class="val" id="k_hottest_night">—</div><div class="mini" id="k_hottest_night_mini">—</div></div>
          <div class="kpi"><div class="lab">Total acima do limiar</div><div class="val" id="k_overall">—</div><div class="mini" id="k_overall_mini">—</div></div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="col6 small">
            <div class="note"><span class="tag">Gráfico 1</span> Tendência anual de Tx/Tn + linha do limiar.</div>
            <canvas id="chartTemps"></canvas>
          </div>
          <div class="col6 small">
            <div class="note"><span class="tag">Gráfico 2</span> Dias/noites acima do limiar (mês/ano).</div>
            <canvas id="chartCounts"></canvas>
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="col6 small">
            <div class="note"><span class="tag">Gráfico 3</span> Tx vs Tn (mensal).</div>
            <canvas id="chartScatter"></canvas>
          </div>
          <div class="col6">
            <div class="note"><span class="tag">R² e p</span></div>
            <div class="controls" style="margin-top:6px">
              <select class="select" id="relPick">
                <option value="daysnights">Dias vs Noites acima do limiar</option>
                <option value="tx_tn_month">Tx vs Tn (média mensal)</option>
                <option value="idt_daynight_daily">IDT dia vs IDT noite (diário)</option>
                <option value="idt_daynight_month">IDT dia vs IDT noite (média mensal)</option>
              </select>
              <span class="note" id="relOut">—</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2>IDT/THI — conforto/desconforto (Thom)</h2>
        <div class="controls">
          <select class="select" id="thiMetric">
            <option value="day">IDT do dia (Tx)</option>
            <option value="night">IDT da noite (Tn)</option>
          </select>
          <select class="select" id="thiClass"></select>
          <button class="btn" id="thiModeYear">Contar por ano</button>
          <button class="btn primary" id="thiModeMonth">Contar por mês</button>
        </div>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi"><div class="lab">O que está sendo contado</div><div class="val" id="k_thi_desc">—</div><div class="mini" id="k_thi_desc2">—</div></div>
          <div class="kpi"><div class="lab">Total na classe</div><div class="val" id="k_thi_total">—</div><div class="mini">Dias na classe selecionada</div></div>
          <div class="kpi"><div class="lab">Média do IDT</div><div class="val" id="k_thi_mean">—</div><div class="mini">Média do período</div></div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="col6 small">
            <div class="note"><span class="tag">Gráfico 4</span> Dias na classe selecionada (mês/ano).</div>
            <canvas id="chartTHI"></canvas>
          </div>
          <div class="col6 small">
            <div class="note"><span class="tag">Gráfico 5</span> IDT médio no tempo (com faixas).</div>
            <canvas id="chartTHIBands"></canvas>
          </div>
        </div>

        <div class="note" style="margin-top:10px">
          Classes (Thom): &lt;21 confortável • 21–24 leve • 24–27 moderado • 27–29 forte • 29–32 estresse • ≥32 emergência.
          Fórmula: IDT/THI = T − (0,55 − 0,0055·UR)·(T − 14,5).
        </div>
      </div>
    </div>
  </section>

  <section id="tabTabelas" class="tab">
    <div class="card">
      <div class="hd"><h2>Tabelas</h2><div class="note">Se ficar pesado, ignore esta aba.</div></div>
      <div class="bd">
        <div class="note"><b>Tabela 1</b> — Tx/Tn + contagens</div>
        <div class="tablewrap" style="margin-top:10px"><table id="tbl"><thead><tr id="tblHead"></tr></thead><tbody id="tblBody"></tbody></table></div>
        <div class="divider"></div>
        <div class="note"><b>Tabela 2</b> — IDT + contagem</div>
        <div class="tablewrap" style="margin-top:10px"><table id="tblTHI"><thead><tr id="thiHead"></tr></thead><tbody id="thiBody"></tbody></table></div>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>

<script>
let DATA=null;
function $(id){ return document.getElementById(id); }
function fmt1(x){ if(x==null||Number.isNaN(x)) return "—"; return (Math.round(x*10)/10).toFixed(1).replace(".",","); }
function fmt0(x){ if(x==null||Number.isNaN(x)) return "—"; return String(Math.round(x)); }
function showErr(msg){ const e=$("err"); e.style.display="block"; e.textContent=msg; }
function setStatus(s){ $("status").textContent=s; }
function ensureLibs(){ 
  if(!window.Chart) throw new Error("Chart.js não carregou (CDN bloqueado?)");
  if(!window.jStat) throw new Error("jStat não carregou (p-values indisponíveis)");
}

let tempThr=31.5;
let currentMode="year";
let thiMode="month";

const THI_CLASSES=[
  "Confortável (sem desconforto)",
  "Leve desconforto (<50%)",
  "Desconforto moderado (>50%)",
  "Forte desconforto (maioria)",
  "Estresse térmico (todos)",
  "Emergência médica (≥32)"
];

let chTemps=null, chCounts=null, chScatter=null, chTHI=null, chTHIB=null;

function destroy(c){ if(c) c.destroy(); }

function pearson(xs,ys){
  const n=xs.length;
  if(n<3) return null;
  const r=jStat.corrcoeff(xs,ys);
  const r2=r*r;
  const t = Math.abs(r) * Math.sqrt((n-2)/(1-r2));
  const p = 2*(1 - jStat.studentt.cdf(t, n-2));
  return ({r,r2,p,n});
}

function aggThreshold(mode, highlightYear) {
  const keyFn = (mode==="year") ? (d=>d.year) : (d=>d.ym);
  const map = new Map();
  for (const d of DATA.daily) {
    if (mode==="month" && highlightYear && d.year !== Number(highlightYear)) continue;
    const Tx=d.Tx, Tn=d.Tn;
    if (Tx==null||Tn==null||Number.isNaN(Tx)||Number.isNaN(Tn)) continue;
    const k = keyFn(d);
    if (!map.has(k)) map.set(k, {key:k, days:0, dayExceed:0, nightExceed:0});
    const o = map.get(k);
    o.days += 1;
    if (Tx > tempThr) o.dayExceed += 1;
    if (Tn > tempThr) o.nightExceed += 1;
  }
  const keys = Array.from(map.keys()).sort((a,b)=>String(a).localeCompare(String(b)));
  return keys.map(k=>map.get(k));
}

function setPills() {
  $("cov").textContent = DATA.summary.coverage.start + " → " + DATA.summary.coverage.end;
  $("thrShow").textContent = String(tempThr).replace(",",".");
}

function setHotKpis() {
  const s = DATA.summary;
  $("k_hottest_day").innerHTML = s.hottest_day.date + " — <b>" + fmt1(s.hottest_day.Tx) + "°C</b>";
  $("k_hottest_day_mini").textContent = "Tx=" + fmt1(s.hottest_day.Tx) + "°C | Tn=" + fmt1(s.hottest_day.Tn) + "°C";
  $("k_hottest_night").innerHTML = s.hottest_night.date + " — <b>" + fmt1(s.hottest_night.Tn) + "°C</b>";
  $("k_hottest_night_mini").textContent = "Tn=" + fmt1(s.hottest_night.Tn) + "°C | Tx=" + fmt1(s.hottest_night.Tx) + "°C";
}

function updateOverallKpi() {
  const rows = aggThreshold("year", null);
  const totalDay = rows.reduce((a,r)=>a + r.dayExceed,0);
  const totalNight = rows.reduce((a,r)=>a + r.nightExceed,0);
  $("k_overall").innerHTML = fmt0(totalDay) + " dias (Tx) • " + fmt0(totalNight) + " noites (Tn)";
  $("k_overall_mini").textContent = "Limiar = " + fmt1(tempThr) + "°C";
}

function renderRelations(mode, highlightYear) {
  const pick=$("relPick").value;
  let xs=[], ys=[];
  if(pick==="daysnights"){
    const rows=(mode==="year")?aggThreshold("year",null):aggThreshold("month",highlightYear);
    xs=rows.map(r=>r.dayExceed); ys=rows.map(r=>r.nightExceed);
  } else if(pick==="tx_tn_month"){
    const m=DATA.monthly.filter(r=>r.year>=2003);
    xs=m.map(r=>r.Tn_mean); ys=m.map(r=>r.Tx_mean);
  } else if(pick==="idt_daynight_daily"){
    const d=DATA.daily.filter(r=>r.THI_day!=null && r.THI_night!=null);
    xs=d.map(r=>r.THI_day); ys=d.map(r=>r.THI_night);
  } else if(pick==="idt_daynight_month"){
    const m=DATA.monthly.filter(r=>r.year>=2003);
    xs=m.map(r=>r.THI_day_mean); ys=m.map(r=>r.THI_night_mean);
  }
  const out=pearson(xs,ys);
  if(!out){ $("relOut").textContent="R²=— • p=— • n=—"; return; }
  const ptxt = out.p<0.001 ? "p<0,001" : ("p=" + out.p.toFixed(3).replace(".",","));
  $("relOut").textContent = "R²=" + out.r2.toFixed(3).replace(".",",") + " • " + ptxt + " • n=" + out.n;
}

function makeCharts(mode, highlightYear) {
  const yrs = DATA.yearly.filter(r=>r.year>=2003).map(r=>String(r.year));
  const tx = DATA.yearly.filter(r=>r.year>=2003).map(r=>r.Tx_mean);
  const tn = DATA.yearly.filter(r=>r.year>=2003).map(r=>r.Tn_mean);

  destroy(chTemps);
  chTemps = new Chart($("chartTemps"), {
    type:"line",
    data:{labels:yrs, datasets:[
      {label:"Tx média (°C)", data:tx},
      {label:"Tn média (°C)", data:tn},
      {label:"Limiar", data:yrs.map(_=>tempThr), borderDash:[6,5]}
    ]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{x:{ticks:{maxRotation:45,minRotation:45}}}}
  });

  const rows = (mode==="year") ? aggThreshold("year", null) : aggThreshold("month", highlightYear);
  const labels = rows.map(r=>String(r.key));
  destroy(chCounts);
  chCounts = new Chart($("chartCounts"), {
    type:"bar",
    data:{labels, datasets:[
      {label:"Tx>limiar", data:rows.map(r=>r.dayExceed)},
      {label:"Tn>limiar", data:rows.map(r=>r.nightExceed)}
    ]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{x:{ticks:{maxRotation:45,minRotation:45}}}}
  });

  const m=DATA.monthly.filter(r=>r.year>=2003);
  destroy(chScatter);
  chScatter = new Chart($("chartScatter"), {
    type:"scatter",
    data:{datasets:[{label:"Meses", data:m.map(r=>({x:r.Tn_mean, y:r.Tx_mean}))}]},
    options:{responsive:true, maintainAspectRatio:false,
      scales:{x:{title:{display:true,text:"Tn média (°C)"}}, y:{title:{display:true,text:"Tx média (°C)"}}},
      plugins:{legend:{display:true}}
    }
  });

  updateOverallKpi();
  renderRelations(mode, highlightYear);
}

function fillYearPicker() {
  const years = DATA.yearly.map(r=>r.year).filter(y=>y>=2003);
  const sel = $("yearPick");
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Filtrar ano (modo mês)…";
  sel.appendChild(opt0);
  years.forEach(y=>{ const o=document.createElement("option"); o.value=y; o.textContent=y; sel.appendChild(o); });
}

function fillTHIClass() {
  const sel=$("thiClass"); sel.innerHTML="";
  THI_CLASSES.forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; sel.appendChild(o); });
  sel.value="Forte desconforto (maioria)";
}

function computeTHIAgg(metric, cls) {
  const key = (thiMode==="year") ? "year" : "ym";
  const map=new Map();
  for (const d of DATA.daily) {
    const k=d[key];
    const idt = (metric==="day") ? d.THI_day : d.THI_night;
    const cat = (metric==="day") ? d.cat_day : d.cat_night;
    if(idt==null||Number.isNaN(idt)) continue;
    if(!map.has(k)) map.set(k, {n:0, match:0, sum:0});
    const o=map.get(k);
    o.n += 1; o.sum += idt;
    if(cat===cls) o.match += 1;
  }
  const keys=Array.from(map.keys()).sort((a,b)=>String(a).localeCompare(String(b)));
  const labels=keys.map(k=>String(k));
  const counts=keys.map(k=>map.get(k).match);
  const means=keys.map(k=>map.get(k).sum/map.get(k).n);
  let sumAll=0, nAll=0;
  for(const k of keys){ sumAll += map.get(k).sum; nAll += map.get(k).n; }
  return {labels, counts, means, total:counts.reduce((a,b)=>a+b,0), meanAll:nAll?sumAll/nAll:null};
}

function renderTHI() {
  const metric=$("thiMetric").value;
  const cls=$("thiClass").value;
  const agg=computeTHIAgg(metric, cls);
  $("k_thi_desc").textContent=(thiMode==="year"?"Por ano":"Por mês")+" — "+(metric==="day"?"IDT do dia":"IDT da noite");
  $("k_thi_desc2").textContent="Classe: "+cls;
  $("k_thi_total").textContent=fmt0(agg.total);
  $("k_thi_mean").textContent=fmt1(agg.meanAll);

  destroy(chTHI);
  chTHI = new Chart($("chartTHI"), {
    type:"bar",
    data:{labels:agg.labels, datasets:[{label:"Dias na classe", data:agg.counts}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{x:{ticks:{maxRotation:45,minRotation:45}}}}
  });

  destroy(chTHIB);
  chTHIB = new Chart($("chartTHIBands"), {
    type:"line",
    data:{labels:agg.labels, datasets:[{label:"IDT médio", data:agg.means, pointRadius:2}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{x:{ticks:{maxRotation:45,minRotation:45}}}}
  });
}

function wireTabs() {
  document.querySelectorAll(".tabbtn").forEach(b=>b.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById(b.dataset.tab).classList.add("active");
  }));
}

async function boot() {
  try {
    ensureLibs();
    setStatus("baixando data.json…");
    const res = await fetch("./data.json", {cache:"no-store"});
    if(!res.ok) throw new Error("Falha ao carregar data.json: " + res.status);
    DATA = await res.json();
    setStatus("ok");
    tempThr = DATA.summary.default_threshold || 31.5;
    $("thrInput").value = tempThr;
    setPills(); setHotKpis(); fillYearPicker(); fillTHIClass(); wireTabs();

    $("viewYear").onclick=()=>{ currentMode="year"; makeCharts("year", null); };
    $("viewMonth").onclick=()=>{ currentMode="month"; makeCharts("month", $("yearPick").value); };
    $("yearPick").onchange=()=>{ if(currentMode==="month") makeCharts("month", $("yearPick").value); };

    $("applyThr").onclick=()=>{ const v=parseFloat($("thrInput").value); if(!Number.isNaN(v)){ tempThr=v; setPills(); makeCharts(currentMode, $("yearPick").value); } };
    $("resetThr").onclick=()=>{ tempThr=31.5; $("thrInput").value=31.5; setPills(); makeCharts(currentMode, $("yearPick").value); };

    $("relPick").onchange=()=>renderRelations(currentMode, $("yearPick").value);

    $("thiModeYear").onclick=()=>{ thiMode="year"; renderTHI(); };
    $("thiModeMonth").onclick=()=>{ thiMode="month"; renderTHI(); };
    $("thiMetric").onchange=renderTHI;
    $("thiClass").onchange=renderTHI;

    makeCharts("year", null);
    renderTHI();
  } catch(e) {
    setStatus("erro");
    showErr(String(e));
    console.error(e);
  }
}

boot();
</script>
</body>
</html>
